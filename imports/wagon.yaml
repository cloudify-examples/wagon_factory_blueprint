inputs:

  plugin_zip:
    type: string

  wagon_location:
    default:
      url: { get_input: plugin_zip }

  venv_create_args:
    default: {}

  wagon_create_args:
    default:
      python_versions: [27]


node_types:

  cloudify.nodes.SoftwareComponent.Wagon:
    derived_from: cloudify.nodes.SoftwareComponent
    properties:
      resource_config:
        default:
          url: # can also be file resource packaged with blueprint.
            required: false
            type: string
      port:
        default: 8080
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: scripts/wagon/create.py
          inputs:
            venv_create_args:
              default: { get_input: venv_create_args }
            wagon_create_args:
              default: { get_input: wagon_create_args }
        configure:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            # Path to the script relative to the blueprint directory
            script_path:
              default: scripts/wagon/build_wagon.py
            process:
              default:
                cwd: '/tmp'
                command_prefix: { get_attribute: [ SELF, python_path ] }
                env:
                  wagon_source: { get_attribute: [ SELF, source ] }
                  wagon_create_args: { get_attribute: [ SELF, wagon_create_args ] }
                  upgrade_pip: true
                  init_file: { get_attribute: [ SELF, init_file ] }
            fabric_env:
              default:
                host_string: { get_attribute: [ host, ip ] }
                user: { get_input: agent_user }
                key: { get_secret: agent_key_private }
        start:
          implementation: scripts/wagon/start.py
        stop:
          implementation: scripts/wagon/stop.py
        delete:
          implementation: scripts/wagon/delete.py

node_templates:

  wagon:
    type: cloudify.nodes.SoftwareComponent.Wagon
    properties:
      resource_config: { get_input: wagon_location }
    relationships:
    - type: cloudify.relationships.contained_in
      target: host
